<!DOCTYPE html>
<html lang="sv" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Rapportera po√§ng</title>
    <th:insert th:replace="~{fragments :: metadata}"></th:insert>
    <script th:inline="javascript">
        var msg = /*[[${alertmsg}]]*/ null;
        console.log("message " + msg);
    </script>
    <script th:src="@{/js/score.js}"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
<div class="nav-box">
    <h1>Rapportera po√§ng</h1>
</div>

<!-- Include messages -->
<div th:insert="~{fragments :: messages(${errormsg}, ${confirmmsg})}"></div>

<form th:action="@{/score}" th:object="${score}" method="post" class="form-general">
    <input type="hidden" th:field="*{id}"/>
    <input type="hidden" th:field="*{station.id}"/>

    <p>Vald kontroll: <span th:text="${station.stationName}"></span></p>

    <!-- QR Scanner Section -->
    <div th:if=${config.useQr} class="form-box qr-scanner-section">
        <button type="button" id="scanQrButton" class="btn-scan">
            üì∑ Scanna QR-kod f√∂r att v√§lja patrull
        </button>
        <div id="qrReader" style="display:none;"></div>
        <div id="qrStatus" style="display:none; margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 4px;">
            <strong>‚úì Patrull vald via QR-kod</strong>
        </div>
    </div>

    <!-- Hidden stationId so it persists -->
    <input type="hidden" th:field="*{station.id}"/>

    <div class="form-box">
        <div class="station-container">
            <!-- Left side: patrol dropdown -->
            <div class="dropdown-area">
                <fieldset>
                    <label for="patrol">Patrull:</label>
                    <select th:field="*{patrol}" id="patrol">
                        <option value="">-- V√§lj patrull --</option>
                        <option th:each="patrol : ${patrols}"
                                th:value="${patrol.patrolId}"
                                th:text="${patrol.patrolName}">
                        </option>
                    </select>
                </fieldset>
            </div>

            <!-- Right side: quick number pad -->
            <div class="numpad-area">
                <label class="numpad-display">Nr: <span id="current_filter"></span></label>

                <div class="numpad-grid">
                    <button type="button" onclick="filterPatrol(7)">7</button>
                    <button type="button" onclick="filterPatrol(8)">8</button>
                    <button type="button" onclick="filterPatrol(9)">9</button>

                    <button type="button" onclick="filterPatrol(4)">4</button>
                    <button type="button" onclick="filterPatrol(5)">5</button>
                    <button type="button" onclick="filterPatrol(6)">6</button>

                    <button type="button" onclick="filterPatrol(1)">1</button>
                    <button type="button" onclick="filterPatrol(2)">2</button>
                    <button type="button" onclick="filterPatrol(3)">3</button>

                    <button type="button" onclick="clearFilter()">C</button>
                    <button type="button" onclick="filterPatrol(0)">0</button>
                    <button type="button" onclick="backspaceFilter()">&lt;</button>
                </div>
            </div>
        </div>
    </div>


    <div th:replace="~{fragments_edit_score :: editScore(${score})}"></div>

    <div class="submit-area">
        <button type="submit">Spara</button>
        | <a th:href="@{/startmenu}">Avbryt</a>
    </div>
</form>
<script>
    // QR Scanner functionality
    const scanButton = document.getElementById('scanQrButton');
    const qrReaderDiv = document.getElementById('qrReader');
    const qrStatus = document.getElementById('qrStatus');
    const patrolSelect = document.getElementById('patrol');
    let html5QrCode;
    let isScanning = false;

    scanButton.addEventListener('click', function() {
        if (isScanning) {
            // Stop scanning
            html5QrCode.stop().then(() => {
                qrReaderDiv.style.display = 'none';
                scanButton.textContent = 'üì∑ Scanna QR-kod f√∂r att v√§lja patrull';
                isScanning = false;
            }).catch((err) => {
                console.error('Error stopping scanner:', err);
            });
        } else {
            // Start scanning
            qrReaderDiv.style.display = 'block';
            scanButton.textContent = '‚èπ Stoppa scanning';
            isScanning = true;

            html5QrCode = new Html5Qrcode("qrReader");

            html5QrCode.start(
                { facingMode: "environment" }, // Use back camera
                {
                    fps: 10,
                    qrbox: { width: 250, height: 250 }
                },
                (decodedText) => {
                    console.log('QR decoded:', decodedText);

                    // Find and select the patrol by ID
                    const patrolId = decodedText.trim();
                    let found = false;

                    for (let i = 0; i < patrolSelect.options.length; i++) {
                        if (patrolSelect.options[i].value === patrolId) {
                            patrolSelect.selectedIndex = i;
                            found = true;
                            break;
                        }
                    }

                    // Stop scanning and show success
                    html5QrCode.stop().then(() => {
                        qrReaderDiv.style.display = 'none';
                        scanButton.textContent = 'üì∑ Scanna QR-kod f√∂r att v√§lja patrull';
                        isScanning = false;

                        if (found) {
                            qrStatus.style.display = 'block';
                            qrStatus.innerHTML = '<strong>‚úì Patrull vald: ' +
                                patrolSelect.options[patrolSelect.selectedIndex].text + '</strong>';

                            // Hide success message after 3 seconds
                            setTimeout(() => {
                                qrStatus.style.display = 'none';
                            }, 3000);
                        } else {
                            alert('Patrull med ID ' + patrolId + ' hittades inte i listan.');
                        }
                    });
                },
                (errorMessage) => {
                    // Ignore continuous scan errors
                }
            ).catch((err) => {
                console.error('Unable to start scanning', err);
                alert('Kunde inte starta kamera. Kontrollera att du har gett tillst√•nd till kameran.');
                qrReaderDiv.style.display = 'none';
                scanButton.textContent = 'üì∑ Scanna QR-kod f√∂r att v√§lja patrull';
                isScanning = false;
            });
        }
    });
</script>
<style>
    .qr-scanner-section {
        text-align: center;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .btn-scan {
        background: #2196F3;
        color: white;
        border: none;
        padding: 12px 24px;
        font-size: 16px;
        border-radius: 6px;
        cursor: pointer;
        width: 100%;
        max-width: 400px;
    }

    .btn-scan:hover {
        background: #1976D2;
    }

    #qrReader {
        margin: 15px auto;
        max-width: 500px;
    }
</style>
</body>
</html>
